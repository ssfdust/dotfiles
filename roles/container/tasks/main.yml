- name: Install podman packages
  become: true
  package:
    name:
      - buildah
      - podman
      - podman-compose
      - skopeo
- name: Switch to nju repo
  become: true
  replace:
    path: "{{ item.path }}"
    regexp: "{{ item.orig }}"
    replace: "{{ item.new }}"
  with_items:
    - { orig: 'docker\.io', new: 'docker.nju.edu.cn', path: "/etc/containers/registries.conf.d/00-shortnames.conf" }
    - { orig: 'quay\.io', new: 'quay.nju.edu.cn', path: "/etc/containers/registries.conf.d/00-shortnames.conf" }
    - { orig: "{{ registries_match }}", new: "{{ new_registries }}", path: "/etc/containers/registries.conf" }
  vars:
    registries_match: '[#]*\s*unqualified-search-registries.*'
    new_registries: >-
      unqualified-search-registries = ["docker.nju.edu.cn"]
- name: Enable podman services
  become: true
  systemd:
    daemon_reload: true
    name: "{{ item }}"
    enabled: yes
  with_items:
    - "podman-restart"
    - podman
- name: "Set subuid and subgid for {{ ansible_user_id }}"
  become: true
  shell: |
    usermod --add-subuids 100000-165535 --add-subgids 100000-165535 {{ ansible_user_id }}
- import_tasks: cockpit.yml
